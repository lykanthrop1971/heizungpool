# ui_touch_display.yaml - LVGL-LITE (ESPHome 2025.7.5) - Portrait 240x320
# Goals:
# - NO continuous redraw (display update_interval: never + auto_clear_enabled: false)
# - Refresh ONLY the currently visible page (status/control/pool)
# - System page updates ONLY while System page is visible
# - Force-refresh when switching pages or after user interaction (instant feedback)
# - Keep your existing geometry/widgets (no overlaps, fixed layout)

globals:
  - id: ui_ready
    type: bool
    restore_value: no
    initial_value: "false"

  - id: ui_busy
    type: bool
    restore_value: no
    initial_value: "false"

  # active page: 0=status, 1=control, 2=pool, 3=system
  - id: ui_page
    type: int
    restore_value: no
    initial_value: "0"

  # force a refresh regardless of dirty detection (e.g. after page switch)
  - id: ui_force_refresh
    type: bool
    restore_value: no
    initial_value: "true"

  - id: ui_mode_cache
    type: int
    restore_value: no
    initial_value: "-1"

  - id: ui_mode_dirty
    type: bool
    restore_value: no
    initial_value: "false"

  - id: ui_dirty
    type: bool
    restore_value: no
    initial_value: "true"

  - id: ui_last_vl
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_out
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_kessel
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_rl
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_ww
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_mixer
    type: float
    restore_value: no
    initial_value: "NAN"

  # pump states cached as 0/1 floats
  - id: ui_last_pump_hz
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_pump_ww
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_pump_hz_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_pump_ww_dirty
    type: bool
    restore_value: no
    initial_value: "false"

esphome:
  on_boot:
    priority: -100
    then:
      - delay: 10000ms
      - lambda: |-
          id(ui_ready) = true;
          id(ui_force_refresh) = true;
      - script.execute: ui_refresh_fast
      - script.execute: ui_refresh_slow

# ---------------- Fonts ----------------
# (kept as-is to avoid layout surprises)
font:
  - file: "gfonts://Roboto"
    id: ui_font_xl
    size: 30
    glyphs: ' 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzÄÖÜäöüß°%:+-–·±().,/_'
  - file: "gfonts://Roboto"
    id: ui_font_l
    size: 22
    glyphs: ' 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzÄÖÜäöüß°%:+-–·±().,/_'
  - file: "gfonts://Roboto"
    id: ui_font_m
    size: 17
    glyphs: ' 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzÄÖÜäöüß°%:+-–·±().,/_'
  - file: "gfonts://Roboto"
    id: ui_font_s
    size: 13
    glyphs: ' 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzÄÖÜäöüß°%:+-–·±().,/_'
  - file: "materialdesignicons-webfont.ttf"
    id: mdi_wifi_24
    size: 24
    glyphs:
      - "\U000F091F"
      - "\U000F0922"
      - "\U000F0925"
      - "\U000F0928"
      - "\U000F092D"

# ---------------- Display ----------------
display:
  - platform: ili9xxx
    id: tft
    model: ili9341
    spi_id: spi_tft
    cs_pin: GPIO8
    dc_pin: GPIO48
    reset_pin: GPIO14
    invert_colors: false
    data_rate: 10MHz
    rotation: 0
    update_interval: never
    auto_clear_enabled: false   # <<< important for LVGL-lite

# ---------------- Touch ----------------
touchscreen:
  - platform: xpt2046
    id: touch
    spi_id: spi_touch
    cs_pin: GPIO38
    display: tft
    update_interval: 150ms      # <<< a bit slower = less CPU jitter
    threshold: 400

    calibration:
      x_min: 392
      x_max: 3725
      y_min: 423
      y_max: 3791

    transform:
      swap_xy: false
      mirror_x: false
      mirror_y: true

# ---------------- Internal system helpers ----------------
sensor:
  - platform: uptime
    id: ui_uptime_s
    update_interval: 10s
    internal: true

  - platform: wifi_signal
    id: ui_wifi_rssi
    update_interval: 10s
    internal: true

interval:
  # FAST: only when NOT on system page (system page is handled by slow refresh)
  - interval: 5s
    startup_delay: 2s
    then:
      - if:
          condition:
            lambda: 'return id(ui_ready) && !id(ui_busy) && (id(ui_page) != 3 || id(ui_force_refresh));'
          then:
            - script.execute: ui_refresh_fast

  # SLOW: only while system page is visible (or forced)
  - interval: 15s
    startup_delay: 9s
    then:
      - if:
          condition:
            lambda: 'return id(ui_ready) && !id(ui_busy) && (id(ui_page) == 3 || id(ui_force_refresh));'
          then:
            - script.execute: ui_refresh_slow

# ---------------- UI refresh ----------------
script:
  - id: ui_refresh_fast
    mode: restart
    then:
      # --- hard guard ---
      - if:
          condition:
            lambda: 'return !id(ui_ready) || id(ui_busy);'
          then:
            - lambda: 'return;'
          else:
            - lambda: 'id(ui_busy) = true;'

      # --- heap guard ---
      - if:
          condition:
            lambda: |-
              return isfinite(id(dbg_heap_free_bytes).state) && id(dbg_heap_free_bytes).state < 30000;
          then:
            - lambda: 'id(ui_busy) = false; return;'

      # --- Detect mode change ONCE ---
      - lambda: |-
          int new_mode = -1;
          const std::string m = id(heizmodus_select).state;
          if      (m == "auto")   new_mode = 0;
          else if (m == "summer") new_mode = 1;
          else if (m == "winter") new_mode = 2;
          else if (m == "pool")   new_mode = 3;

          bool mode_dirty = (new_mode != id(ui_mode_cache));
          id(ui_mode_dirty) = mode_dirty;
          if (mode_dirty) id(ui_mode_cache) = new_mode;

      # --- Dirty detection (only mark dirty; per-page update later) ---
      - lambda: |-
          auto chg = [&](float &last, float cur, float eps)->bool{
            const bool cfin = std::isfinite(cur);
            const bool lfin = std::isfinite(last);
            if (!cfin && !lfin) return false;
            if (cfin != lfin) { last = cur; return true; }
            if (fabsf(cur - last) >= eps) { last = cur; return true; }
            return false;
          };

          bool d = false;

          d |= chg(id(ui_last_vl),    id(vorlauftemperatur).state,     0.1f);
          d |= chg(id(ui_last_kessel),id(kesseltemperatur).state,      0.1f);
          d |= chg(id(ui_last_rl),    id(ruecklauftemperatur).state,   0.1f);
          d |= chg(id(ui_last_ww),    id(warmwassertemperatur).state,  0.1f);
          d |= chg(id(ui_last_out),   id(outdoor).state,               0.1f);
          d |= chg(id(ui_last_mixer), id(mischer_position),            1.0f);

          const float phz = id(heizkreispumpe).state ? 1.0f : 0.0f;
          const float pww = id(warmwasserpumpe).state ? 1.0f : 0.0f;
          const bool hz_dirty = chg(id(ui_last_pump_hz), phz, 0.5f);
          const bool ww_dirty = chg(id(ui_last_pump_ww), pww, 0.5f);
          d |= hz_dirty;
          d |= ww_dirty;
          id(ui_pump_hz_dirty) = hz_dirty;
          id(ui_pump_ww_dirty) = ww_dirty;

          d |= id(ui_mode_dirty);

          // force refresh (page switch / user action)
          if (id(ui_force_refresh)) d = true;

          id(ui_dirty) = d;

      - if:
          condition:
            lambda: 'return !id(ui_dirty);'
          then:
            - lambda: 'id(ui_busy) = false; return;'

      # --- Update ONLY the active page ---
      - lambda: |-
          ESP_LOGD("ui","refresh_fast: page=%d force=%d mode_dirty=%d",
                   id(ui_page), id(ui_force_refresh), id(ui_mode_dirty));

      # =========================
      # PAGE 0: STATUS
      # =========================
      - if:
          condition:
            lambda: 'return id(ui_page) == 0;'
          then:
            # Hero
            - lvgl.label.update:
                id: lbl_hero_vl
                text: !lambda |-
                  if (!std::isfinite(id(vorlauftemperatur).state)) return std::string("-");
                  char b[16]; snprintf(b, sizeof(b), "%.1f°C", id(vorlauftemperatur).state);
                  return std::string(b);

            - lvgl.label.update:
                id: lbl_hero_vl_soll
                text: !lambda |-
                  float v = id(zieltemperatur_input).state;
                  if (!std::isfinite(v)) return std::string("Soll: -");
                  char b[24]; snprintf(b, sizeof(b), "Soll: %.1f°C", v);
                  return std::string(b);

            - lvgl.label.update:
                id: lbl_hero_mixer
                text: !lambda |-
                  const float v = id(mischer_position);
                  if (!std::isfinite(v)) return std::string("Mischer: -");
                  char b[24]; snprintf(b, sizeof(b), "Mischer: %.0f%%", v);
                  return std::string(b);

            - delay: 1ms

            # Header: pumps + wifi (only exists on status page)
            - if:
                condition:
                  lambda: "return id(ui_pump_hz_dirty) || id(ui_force_refresh);"
                then:
                  - lvgl.label.update: { id: lbl_pump_hz, text: "H" }
                  - if:
                      condition:
                        lambda: "return id(heizkreispumpe).state;"
                      then:
                        - lvgl.label.update: { id: lbl_pump_hz, styles: pump_on }
                      else:
                        - lvgl.label.update: { id: lbl_pump_hz, styles: pump_off }

            - if:
                condition:
                  lambda: "return id(ui_pump_ww_dirty) || id(ui_force_refresh);"
                then:
                  - lvgl.label.update: { id: lbl_pump_ww, text: "W" }
                  - if:
                      condition:
                        lambda: "return id(warmwasserpumpe).state;"
                      then:
                        - lvgl.label.update: { id: lbl_pump_ww, styles: pump_on }
                      else:
                        - lvgl.label.update: { id: lbl_pump_ww, styles: pump_off }

            - lvgl.label.update:
                id: lbl_wifi_icon
                text: !lambda |-
                  const float r = id(ui_wifi_rssi).state;
                  if (!std::isfinite(r)) return std::string("\U000F092D");
                  if (r >= -55) return std::string("\U000F0928");
                  if (r >= -67) return std::string("\U000F0925");
                  if (r >= -80) return std::string("\U000F0922");
                  return std::string("\U000F091F");

            - delay: 1ms

            # Cards
            - lvgl.label.update:
                id: lbl_card_outdoor
                text: !lambda |-
                  if (!std::isfinite(id(outdoor).state)) return std::string("-");
                  char b[16]; snprintf(b, sizeof(b), "%.1f°C", id(outdoor).state);
                  return std::string(b);

            - lvgl.label.update:
                id: lbl_card_kessel
                text: !lambda |-
                  if (!std::isfinite(id(kesseltemperatur).state)) return std::string("-");
                  char b[16]; snprintf(b, sizeof(b), "%.1f°C", id(kesseltemperatur).state);
                  return std::string(b);

            - lvgl.label.update:
                id: lbl_card_ww
                text: !lambda |-
                  if (!std::isfinite(id(warmwassertemperatur).state)) return std::string("-");
                  char b[16]; snprintf(b, sizeof(b), "%.1f°C", id(warmwassertemperatur).state);
                  return std::string(b);

            - lvgl.label.update:
                id: lbl_card_rl
                text: !lambda |-
                  if (!std::isfinite(id(ruecklauftemperatur).state)) return std::string("-");
                  char b[16]; snprintf(b, sizeof(b), "%.1f°C", id(ruecklauftemperatur).state);
                  return std::string(b);

      # =========================
      # PAGE 1: CONTROL
      # =========================
      - if:
          condition:
            lambda: 'return id(ui_page) == 1;'
          then:
            - lvgl.label.update:
                id: lbl_mode_state
                text: !lambda |-
                  const std::string m = id(heizmodus_select).state;
                  if      (m == "auto")   return std::string("Modus: Auto");
                  else if (m == "summer") return std::string("Modus: Sommer");
                  else if (m == "winter") return std::string("Modus: Winter");
                  else if (m == "pool")   return std::string("Modus: Pool");
                  return std::string("Modus: ?");

            - lvgl.label.update:
                id: lbl_ctl_vl
                text: !lambda |-
                  float v = id(zieltemperatur_input).state;
                  if (!std::isfinite(v)) return std::string("-");
                  char b[16]; snprintf(b, sizeof(b), "%.1f°C", v);
                  return std::string(b);

            - lvgl.label.update:
                id: lbl_ctl_ww
                text: !lambda |-
                  float v = id(warmwasser_zieltemperatur_input).state;
                  if (!std::isfinite(v)) return std::string("-");
                  char b[16]; snprintf(b, sizeof(b), "%.1f°C", v);
                  return std::string(b);

            - delay: 1ms

      # =========================
      # PAGE 2: POOL
      # =========================
      - if:
          condition:
            lambda: 'return id(ui_page) == 2;'
          then:
            - lvgl.label.update:
                id: lbl_pool_fp
                text: !lambda |-
                  return id(filter_pumpe_enable_dac).state ? std::string("EIN") : std::string("AUS");

            - lvgl.label.update:
                id: lbl_pool_speed
                text: !lambda |-
                  float v = id(filter_pumpe_speed_pct).state;
                  if (!std::isfinite(v)) return std::string("-");
                  char b[16]; snprintf(b, sizeof(b), "%.0f%%", v);
                  return std::string(b);

            - lvgl.label.update:
                id: lbl_pool_dos
                text: !lambda |-
                  return id(dosierung_enable).state ? std::string("EIN") : std::string("AUS");

            - delay: 1ms

      # =========================
      # Mode highlight:
      # - only on Control page (to save CPU)
      # - update on mode change OR force refresh
      # =========================
      - if:
          condition:
            lambda: |-
              return (id(ui_page) == 1) &&
                     (id(ui_mode_dirty) || id(ui_force_refresh)) &&
                     isfinite(id(dbg_heap_free_bytes).state) &&
                     id(dbg_heap_free_bytes).state > 40000;
          then:
            - if:
                condition:
                  lambda: 'return id(heizmodus_select).state == "auto";'
                then:
                  - lvgl.button.update: { id: btn_mode_auto, styles: mode_btn_active }
                  - lvgl.label.update:  { id: txt_mode_auto, styles: mode_txt_active }
                else:
                  - lvgl.button.update: { id: btn_mode_auto, styles: mode_btn }
                  - lvgl.label.update:  { id: txt_mode_auto, styles: mode_txt }

            - if:
                condition:
                  lambda: 'return id(heizmodus_select).state == "summer";'
                then:
                  - lvgl.button.update: { id: btn_mode_summer, styles: mode_btn_active }
                  - lvgl.label.update:  { id: txt_mode_summer, styles: mode_txt_active }
                else:
                  - lvgl.button.update: { id: btn_mode_summer, styles: mode_btn }
                  - lvgl.label.update:  { id: txt_mode_summer, styles: mode_txt }

            - if:
                condition:
                  lambda: 'return id(heizmodus_select).state == "winter";'
                then:
                  - lvgl.button.update: { id: btn_mode_winter, styles: mode_btn_active }
                  - lvgl.label.update:  { id: txt_mode_winter, styles: mode_txt_active }
                else:
                  - lvgl.button.update: { id: btn_mode_winter, styles: mode_btn }
                  - lvgl.label.update:  { id: txt_mode_winter, styles: mode_txt }

            - if:
                condition:
                  lambda: 'return id(heizmodus_select).state == "pool";'
                then:
                  - lvgl.button.update: { id: btn_mode_pool, styles: mode_btn_active }
                  - lvgl.label.update:  { id: txt_mode_pool, styles: mode_txt_active }
                else:
                  - lvgl.button.update: { id: btn_mode_pool, styles: mode_btn }
                  - lvgl.label.update:  { id: txt_mode_pool, styles: mode_txt }

      # --- clear flags + release guard ---
      - lambda: |-
          id(ui_force_refresh) = false;
          id(ui_busy) = false;

  # Slow refresh: System info (every 15s) - only meaningful on System page
  - id: ui_refresh_slow
    mode: restart
    then:
      - if:
          condition:
            lambda: 'return !id(ui_ready) || id(ui_busy);'
          then:
            - lambda: 'return;'
          else:
            - lambda: 'id(ui_busy) = true;'

      - if:
          condition:
            lambda: |-
              return isfinite(id(dbg_heap_free_bytes).state) && id(dbg_heap_free_bytes).state < 30000;
          then:
            - lambda: 'id(ui_busy) = false; return;'

      # Only update when System page is visible (or forced)
      - if:
          condition:
            lambda: 'return (id(ui_page) == 3) || id(ui_force_refresh);'
          then:
            - lvgl.label.update:
                id: lbl_sys_uptime
                text: !lambda |-
                  float up = id(ui_uptime_s).state;   // seconds
                  if (!std::isfinite(up) || up < 0) return std::string("-");
                  uint32_t s = (uint32_t) up;

                  uint32_t d   = s / 86400;
                  uint32_t rem = s % 86400;
                  uint32_t h   = rem / 3600;
                  uint32_t m   = (rem % 3600) / 60;
                  uint32_t sec = rem % 60;

                  char b[24];
                  snprintf(b, sizeof(b), "%ud %02u:%02u:%02u",
                           (unsigned)d, (unsigned)h, (unsigned)m, (unsigned)sec);
                  return std::string(b);
            - delay: 1ms

            - lvgl.label.update:
                id: lbl_sys_loop
                text: !lambda |-
                  float cur = id(dbg_loop_time).state;
                  float mx  = id(dbg_loop_time_max_boot).state;
                  if (!std::isfinite(cur) || !std::isfinite(mx)) return std::string("-");
                  char b[24];
                  snprintf(b, sizeof(b), "%.0f/%.0f ms", cur, mx);
                  return std::string(b);

            - lvgl.label.update:
                id: lbl_sys_heap
                text: !lambda |-
                  float kb = id(dbg_heap_free_kb).state;
                  if (!std::isfinite(kb)) return std::string("-");
                  char b[20];
                  snprintf(b, sizeof(b), "%.0f KB", kb);
                  return std::string(b);

            - delay: 1ms

            - lvgl.label.update:
                id: lbl_sys_ip
                text: !lambda |-
                  if (!WiFi.isConnected()) return std::string("-");
                  auto ip = WiFi.localIP();
                  char b[20];
                  snprintf(b, sizeof(b), "%u.%u.%u.%u", ip[0], ip[1], ip[2], ip[3]);
                  return std::string(b);

            - delay: 1ms

            - lvgl.label.update:
                id: lbl_sys_reset
                text: !lambda |-
                  esp_reset_reason_t rr = esp_reset_reason();
                  const char* s = "UNKNOWN";
                  switch (rr) {
                    case ESP_RST_UNKNOWN:    s = "UNKNOWN"; break;
                    case ESP_RST_POWERON:    s = "POWERON"; break;
                    case ESP_RST_EXT:        s = "EXT"; break;
                    case ESP_RST_SW:         s = "SW"; break;
                    case ESP_RST_PANIC:      s = "PANIC"; break;
                    case ESP_RST_INT_WDT:    s = "INT_WDT"; break;
                    case ESP_RST_TASK_WDT:   s = "TASK_WDT"; break;
                    case ESP_RST_WDT:        s = "WDT"; break;
                    case ESP_RST_DEEPSLEEP:  s = "DEEPSLEEP"; break;
                    case ESP_RST_BROWNOUT:   s = "BROWNOUT"; break;
                    case ESP_RST_SDIO:       s = "SDIO"; break;
                    case ESP_RST_USB:        s = "USB"; break;
                    case ESP_RST_JTAG:       s = "JTAG"; break;
                    case ESP_RST_EFUSE:      s = "EFUSE"; break;
                    case ESP_RST_PWR_GLITCH: s = "PWR_GLITCH"; break;
                    case ESP_RST_CPU_LOCKUP: s = "CPU_LOCKUP"; break;
                    default: break;
                  }
                  return std::string(s);

      - lambda: |-
          id(ui_force_refresh) = false;
          id(ui_busy) = false;

# ---------------- LVGL (mostly kept; only navigation handlers changed) ----------------
lvgl:
  displays:
    - tft
  touchscreens:
    - touchscreen_id: touch
  color_depth: 16
  buffer_size: 4%              # keep small to stay on the safe side with heap
  disp_bg_color: 0x070B12
  default_font: ui_font_m
  log_level: ERROR

  theme:
    label:
      text_color: 0xE7EEF9
    button:
      bg_color: 0x132033
      bg_opa: COVER
      radius: 14
      border_width: 1
      border_color: 0x22324B
      pressed:
        bg_color: 0x1A2A42
    buttonmatrix:
      bg_opa: TRANSP
      border_width: 0
      pad_all: 0
      items:
        bg_color: 0x0F1726
        bg_opa: COVER
        border_width: 1
        border_color: 0x22324B
        text_color: 0x9FB0C8
        pressed:
          bg_color: 0x1A2A42
          text_color: 0xFFFFFF
        checked:
          bg_color: 0x2B6FFF
          text_color: 0xFFFFFF

  style_definitions:
    - id: hdr
      bg_color: 0x0B1220
      bg_opa: COVER
      border_width: 0
      pad_left: 10
      pad_right: 10
      pad_top: 6
      pad_bottom: 6

    - id: chip
      bg_color: 0x0F1726
      bg_opa: COVER
      radius: 12
      pad_left: 8
      pad_right: 8
      pad_top: 4
      pad_bottom: 4
      border_width: 1
      border_color: 0x22324B

    - id: card
      bg_color: 0x0B1424
      bg_opa: COVER
      radius: 18
      pad_left: 12
      pad_right: 12
      pad_top: 6
      pad_bottom: 6
      border_width: 1
      border_color: 0x22324B

    - id: hero
      bg_color: 0x0D1A2F
      bg_opa: COVER
      radius: 20
      pad_left: 14
      pad_right: 14
      pad_top: 12
      pad_bottom: 10
      border_width: 1
      border_color: 0x2B6FFF

    - id: title
      text_color: 0x9FB0C8
      text_font: ui_font_s

    - id: vxl
      text_color: 0xFFFFFF
      text_font: ui_font_xl

    - id: vl
      text_color: 0xFFFFFF
      text_font: ui_font_l

    - id: vm
      text_color: 0xE7EEF9
      text_font: ui_font_m

    - id: nav
      bg_color: 0x070B12
      bg_opa: COVER
      border_width: 0
      pad_all: 4

    - id: mode_btn
      bg_color: 0x0F1726
      bg_opa: COVER
      radius: 14
      border_width: 1
      border_color: 0x22324B
      pad_left: 8
      pad_right: 8
      pad_top: 6
      pad_bottom: 6

    - id: mode_btn_active
      bg_color: 0x2B6FFF
      bg_opa: COVER
      radius: 14
      border_width: 1
      border_color: 0x2B6FFF
      pad_left: 8
      pad_right: 8
      pad_top: 6
      pad_bottom: 6

    - id: mode_txt
      text_color: 0x9FB0C8
      text_font: ui_font_m

    - id: mode_txt_active
      text_color: 0xFFFFFF
      text_font: ui_font_m

    - id: wifi_icon
      text_font: mdi_wifi_24
      text_color: 0xE7EEF9

    - id: pump_on
      text_color: 0xFF3B30
      text_font: ui_font_s

    - id: pump_off
      text_color: 0xFFFFFF
      text_font: ui_font_s

  # Bottom nav (fixed)
  top_layer:
    widgets:
      - obj:
          align: bottom_mid
          width: 240
          height: 52
          styles: nav
          widgets:
            - buttonmatrix:
                id: nav_matrix
                one_checked: true
                width: 240
                height: 44
                pad_row: 0
                pad_column: 6
                rows:
                  - buttons:
                      - id: nav_status
                        text: "Status"
                        control:
                          checkable: true
                          checked: true
                        on_value:
                          then:
                            - if:
                                condition:
                                  lambda: "return x;"
                                then:
                                  - lvgl.page.show: page_heat_status
                                  - lambda: |-
                                      id(ui_page) = 0;
                                      id(ui_force_refresh) = true;
                                  - script.execute: ui_refresh_fast

                      - id: nav_control
                        text: "Control"
                        control:
                          checkable: true
                        on_value:
                          then:
                            - if:
                                condition:
                                  lambda: "return x;"
                                then:
                                  - lvgl.page.show: page_heat_control
                                  - lambda: |-
                                      id(ui_page) = 1;
                                      id(ui_force_refresh) = true;
                                  - script.execute: ui_refresh_fast

                      - id: nav_pool
                        text: "Pool"
                        control:
                          checkable: true
                        on_value:
                          then:
                            - if:
                                condition:
                                  lambda: "return x;"
                                then:
                                  - lvgl.page.show: page_pool
                                  - lambda: |-
                                      id(ui_page) = 2;
                                      id(ui_force_refresh) = true;
                                  - script.execute: ui_refresh_fast

                      - id: nav_system
                        text: "System"
                        control:
                          checkable: true
                        on_value:
                          then:
                            - if:
                                condition:
                                  lambda: "return x;"
                                then:
                                  - lvgl.page.show: page_system
                                  - lambda: |-
                                      id(ui_page) = 3;
                                      id(ui_force_refresh) = true;
                                  - script.execute: ui_refresh_slow

  pages:
    # Geometry:
    # header: y=0..43 (44px)
    # content: y=48..263 (216px)
    # nav: y=268..319 (52px)

    # =========================
    # STATUS
    # =========================
    - id: page_heat_status
      widgets:
        - obj:
            align: top_left
            x: 0
            y: 0
            width: 240
            height: 44
            styles: hdr
            widgets:
              - label:
                  text: "Heizung"
                  align: left_mid
                  styles: vm
              - label:
                  id: lbl_pump_hz
                  text: "H"
                  align: right_mid
                  x: -78
                  styles: pump_off
              - label:
                  id: lbl_pump_ww
                  text: "W"
                  align: right_mid
                  x: -40
                  styles: pump_off
              - label:
                  id: lbl_wifi_icon
                  text: "\U000F092D"
                  align: right_mid
                  x: -8
                  styles: wifi_icon

        - obj:
            align: top_left
            x: 8
            y: 48
            width: 224
            height: 92
            styles: hero
            widgets:
              - label: { text: "Vorlauf", align: top_left, styles: title }
              - label: { id: lbl_hero_vl, text: "-", align: left_mid, y: 6, styles: vxl }
              - label: { id: lbl_hero_vl_soll, text: "Soll: -", align: bottom_left, styles: title }
              - label: { id: lbl_hero_mixer, text: "Mischer: -", align: bottom_right, styles: title }

        - obj:
            align: top_left
            x: 8
            y: 146
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Außen", styles: title, align: top_left }
              - label: { id: lbl_card_outdoor, text: "-", styles: vl, align: bottom_left }

        - obj:
            align: top_left
            x: 123
            y: 146
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Kessel", styles: title, align: top_left }
              - label: { id: lbl_card_kessel, text: "-", styles: vl, align: bottom_left }

        - obj:
            align: top_left
            x: 8
            y: 208
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Warmwasser", styles: title, align: top_left }
              - label: { id: lbl_card_ww, text: "-", styles: vl, align: bottom_left }

        - obj:
            align: top_left
            x: 123
            y: 208
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Rücklauf", styles: title, align: top_left }
              - label: { id: lbl_card_rl, text: "-", styles: vl, align: bottom_left }

    # =========================
    # CONTROL
    # =========================
    - id: page_heat_control
      widgets:
        - obj:
            align: top_left
            x: 0
            y: 0
            width: 240
            height: 44
            styles: hdr
            widgets:
              - label: { text: "Control", align: left_mid, styles: vm }
              - obj:
                  align: right_mid
                  width: 110
                  height: 26
                  styles: chip
                  widgets:
                    - label: { id: lbl_mode_state, text: "Modus: -", align: center, styles: title }

        - obj:
            align: top_left
            x: 8
            y: 48
            width: 224
            height: 78
            styles: card
            widgets:
              - label: { text: "Heizmodus", align: top_left, styles: title }

              - button:
                  id: btn_mode_auto
                  align: top_left
                  x: 0
                  y: 26
                  width: 52
                  height: 44
                  styles: mode_btn
                  on_press:
                    then:
                      - select.set: { id: heizmodus_select, option: "auto" }
                      - lambda: 'id(ui_force_refresh) = true;'
                      - script.execute: ui_refresh_fast
                  widgets:
                    - label: { id: txt_mode_auto, text: "Auto", align: center, styles: mode_txt }

              - button:
                  id: btn_mode_summer
                  align: top_left
                  x: 58
                  y: 26
                  width: 52
                  height: 44
                  styles: mode_btn
                  on_press:
                    then:
                      - select.set: { id: heizmodus_select, option: "summer" }
                      - lambda: 'id(ui_force_refresh) = true;'
                      - script.execute: ui_refresh_fast
                  widgets:
                    - label: { id: txt_mode_summer, text: "Som", align: center, styles: mode_txt }

              - button:
                  id: btn_mode_winter
                  align: top_left
                  x: 116
                  y: 26
                  width: 52
                  height: 44
                  styles: mode_btn
                  on_press:
                    then:
                      - select.set: { id: heizmodus_select, option: "winter" }
                      - lambda: 'id(ui_force_refresh) = true;'
                      - script.execute: ui_refresh_fast
                  widgets:
                    - label: { id: txt_mode_winter, text: "Win", align: center, styles: mode_txt }

              - button:
                  id: btn_mode_pool
                  align: top_left
                  x: 174
                  y: 26
                  width: 50
                  height: 44
                  styles: mode_btn
                  on_press:
                    then:
                      - select.set: { id: heizmodus_select, option: "pool" }
                      - lambda: 'id(ui_force_refresh) = true;'
                      - script.execute: ui_refresh_fast
                  widgets:
                    - label: { id: txt_mode_pool, text: "Pool", align: center, styles: mode_txt }

        - obj:
            align: top_left
            x: 8
            y: 120
            width: 224
            height: 70
            styles: card
            widgets:
              - label: { text: "Vorlauf Soll", styles: title, align: top_left }
              - label: { id: lbl_ctl_vl, text: "-", styles: vl, align: left_mid, y: 10 }
              - button:
                  width: 56
                  height: 44
                  align: right_mid
                  x: -64
                  on_press:
                    then:
                      - script.execute: { id: ui_vl_nudge, delta: -0.5 }
                      - lambda: 'id(ui_force_refresh) = true;'
                      - script.execute: ui_refresh_fast
                  widgets:
                    - label: { text: "–", align: center, styles: vm }
              - button:
                  width: 56
                  height: 44
                  align: right_mid
                  x: 0
                  on_press:
                    then:
                      - script.execute: { id: ui_vl_nudge, delta: 0.5 }
                      - lambda: 'id(ui_force_refresh) = true;'
                      - script.execute: ui_refresh_fast
                  widgets:
                    - label: { text: "+", align: center, styles: vm }

        - obj:
            align: top_left
            x: 8
            y: 196
            width: 224
            height: 70
            styles: card
            widgets:
              - label: { text: "WW Soll", styles: title, align: top_left }
              - label: { id: lbl_ctl_ww, text: "-", styles: vl, align: left_mid, y: 10 }
              - button:
                  width: 56
                  height: 44
                  align: right_mid
                  x: -64
                  on_press:
                    then:
                      - script.execute: { id: ui_ww_nudge, delta: -0.5 }
                      - lambda: 'id(ui_force_refresh) = true;'
                      - script.execute: ui_refresh_fast
                  widgets:
                    - label: { text: "–", align: center, styles: vm }
              - button:
                  width: 56
                  height: 44
                  align: right_mid
                  x: 0
                  on_press:
                    then:
                      - script.execute: { id: ui_ww_nudge, delta: 0.5 }
                      - lambda: 'id(ui_force_refresh) = true;'
                      - script.execute: ui_refresh_fast
                  widgets:
                    - label: { text: "+", align: center, styles: vm }

    # =========================
    # POOL
    # =========================
    - id: page_pool
      widgets:
        - obj:
            align: top_left
            x: 0
            y: 0
            width: 240
            height: 44
            styles: hdr
            widgets:
              - label: { text: "Pool", align: left_mid, styles: vm }

        - obj:
            align: top_left
            x: 8
            y: 48
            width: 224
            height: 104
            styles: card
            widgets:
              - label: { text: "Filterpumpe", styles: title, align: top_left }
              - label: { text: "Status:", styles: title, align: top_left, y: 18 }
              - label: { id: lbl_pool_fp, text: "-", styles: vm, align: top_left, x: 58, y: 16 }
              - label: { text: "Speed:", styles: title, align: top_left, y: 40 }
              - label: { id: lbl_pool_speed, text: "-", styles: vm, align: top_left, x: 58, y: 38 }
              - button:
                  width: 68
                  height: 44
                  align: bottom_left
                  on_press:
                    then:
                      - script.execute: ui_toggle_filterpump
                      - lambda: 'id(ui_force_refresh) = true;'
                      - script.execute: ui_refresh_fast
                  widgets:
                    - label: { text: "Toggle", align: center, styles: vm }
              - button:
                  width: 68
                  height: 44
                  align: bottom_mid
                  x: -36
                  on_press:
                    then:
                      - script.execute: { id: ui_filterpump_speed_nudge, delta: -5 }
                      - lambda: 'id(ui_force_refresh) = true;'
                      - script.execute: ui_refresh_fast
                  widgets:
                    - label: { text: "-5%", align: center, styles: vm }
              - button:
                  width: 68
                  height: 44
                  align: bottom_mid
                  x: 36
                  on_press:
                    then:
                      - script.execute: { id: ui_filterpump_speed_nudge, delta: 5 }
                      - lambda: 'id(ui_force_refresh) = true;'
                      - script.execute: ui_refresh_fast
                  widgets:
                    - label: { text: "+5%", align: center, styles: vm }

        - obj:
            align: top_left
            x: 8
            y: 158
            width: 224
            height: 108
            styles: card
            widgets:
              - label: { text: "Dosierung", styles: title, align: top_left }
              - label: { text: "Status:", styles: title, align: top_left, y: 18 }
              - label: { id: lbl_pool_dos, text: "-", styles: vm, align: top_left, x: 58, y: 16 }
              - button:
                  width: 224
                  height: 44
                  align: bottom_left
                  on_press:
                    then:
                      - script.execute: ui_toggle_dosierung
                      - lambda: 'id(ui_force_refresh) = true;'
                      - script.execute: ui_refresh_fast
                  widgets:
                    - label: { text: "Toggle", align: center, styles: vm }

    # =========================
    # SYSTEM
    # =========================
    - id: page_system
      widgets:
        - obj:
            align: top_left
            x: 0
            y: 0
            width: 240
            height: 44
            styles: hdr
            widgets:
              - label: { text: "System", align: left_mid, styles: vm }

        - obj:
            align: top_left
            x: 8
            y: 48
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Uptime", styles: title, align: top_left }
              - label: { id: lbl_sys_uptime, text: "-", styles: vm, align: bottom_left }

        - obj:
            align: top_left
            x: 123
            y: 48
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Loop cur/max", styles: title, align: top_left }
              - label: { id: lbl_sys_loop, text: "-", styles: vm, align: bottom_left }

        - obj:
            align: top_left
            x: 8
            y: 110
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Heap", styles: title, align: top_left }
              - label: { id: lbl_sys_heap, text: "-", styles: vm, align: bottom_left }

        - obj:
            align: top_left
            x: 123
            y: 110
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "IP", styles: title, align: top_left }
              - label: { id: lbl_sys_ip, text: "-", styles: title, align: bottom_left }

        - obj:
            align: top_left
            x: 8
            y: 172
            width: 224
            height: 54
            styles: card
            widgets:
              - label: { text: "Reset Reason", styles: title, align: top_left }
              - label: { id: lbl_sys_reset, text: "-", styles: vm, align: bottom_left }

        - button:
            align: top_left
            x: 8
            y: 232
            width: 224
            height: 34
            on_press:
              then:
                - button.press: restart_button
            widgets:
              - label: { text: "Restart", align: center, styles: vm }
