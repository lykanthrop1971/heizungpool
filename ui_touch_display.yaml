# ui_touch_display.yaml — "Product" UI (ESPHome 2025.7.5) — Portrait 240x320
# NO scrolling, NO overlaps, fixed geometry.
#
# Needs these IDs in main config:
# sensors: outdoor, vorlauftemperatur, kesseltemperatur, temp8
# globals: mischer_position (float), vessel_soll (float)   # vessel_soll optional
# number: zieltemperatur_input, warmwasser_zieltemperatur_input
# select: heizmodus_select
# scripts: ui_vl_nudge, ui_ww_nudge, ui_toggle_filterpump, ui_filterpump_speed_nudge, ui_toggle_dosierung
# switch/number (pool optional): filter_pumpe_enable_dac, filter_pumpe_speed_pct, dosierung_enable
# button: restart_button

# ---------------- Fonts (Latin + ß + symbols used) ----------------
font:
  - file: "gfonts://Roboto"
    id: ui_font_xl
    size: 30
    glyphs: ' 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzÄÖÜäöüß°%:+-–—·±().,/'
  - file: "gfonts://Roboto"
    id: ui_font_l
    size: 22
    glyphs: ' 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzÄÖÜäöüß°%:+-–—·±().,/'
  - file: "gfonts://Roboto"
    id: ui_font_m
    size: 17
    glyphs: ' 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzÄÖÜäöüß°%:+-–—·±().,/'
  - file: "gfonts://Roboto"
    id: ui_font_s
    size: 13
    glyphs: ' 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzÄÖÜäöüß°%:+-–—·±().,/'
  # WiFi strength icons (MDI)
  - file: "materialdesignicons-webfont.ttf"
    id: mdi_wifi_24
    size: 24
    glyphs:
      - "\U000F091F" # wifi-strength-1 (F091F) :contentReference[oaicite:0]{index=0}
      - "\U000F0922" # wifi-strength-2 (F0922) :contentReference[oaicite:1]{index=1}
      - "\U000F0925" # wifi-strength-3 (F0925) :contentReference[oaicite:2]{index=2}
      - "\U000F0928" # wifi-strength-4 (F0928) :contentReference[oaicite:3]{index=3}
      - "\U000F092D" # wifi-strength-off (F092D) :contentReference[oaicite:4]{index=4}
# ---------------- Display (your known working wiring) ----------------
display:
  - platform: ili9xxx
    id: tft
    model: ili9341
    spi_id: spi_tft
    cs_pin: GPIO8
    dc_pin: GPIO48
    reset_pin: GPIO14
    invert_colors: false
    data_rate: 10MHz
    rotation: 0
    update_interval: never

# ---------------- Touch (your known working wiring) ----------------
touchscreen:
  - platform: xpt2046
    id: touch
    spi_id: spi_touch
    cs_pin: GPIO38
#    interrupt_pin: GPIO47
    display: tft
    update_interval: 50ms
    threshold: 400

    calibration:
      x_min: 392
      x_max: 3725
      y_min: 423
      y_max: 3791

    transform:
      swap_xy: false
      mirror_x: false
      mirror_y: true

# ---------------- Internal system helpers ----------------
sensor:
  - platform: uptime
    id: ui_uptime_s
    update_interval: 10s
    internal: true

  - platform: wifi_signal
    id: ui_wifi_rssi
    update_interval: 10s
    internal: true

interval:
  - interval: 1s
    then:
      - script.execute: ui_refresh

# ---------------- UI refresh ----------------
script:
  - id: ui_refresh
    mode: restart
    then:
      # ---------- Header chips ----------
      # - lvgl.label.update:
      #     id: lbl_hdr_rssi
      #     text: !lambda |-
      #       if (!std::isfinite(id(ui_wifi_rssi).state)) return std::string("WiFi: -");
      #       char b[24];
      #       snprintf(b, sizeof(b), "WiFi: %.0f", id(ui_wifi_rssi).state);
      #       return std::string(b);

      # ---------- Status (Hero + cards) ----------
      - lvgl.label.update:
          id: lbl_hero_vl
          text: !lambda |-
            if (!std::isfinite(id(vorlauftemperatur).state)) return std::string("—");
            char b[16];
            snprintf(b, sizeof(b), "%.1f°C", id(vorlauftemperatur).state);
            return std::string(b);

      - lvgl.label.update:
          id: lbl_hero_vl_soll
          text: !lambda |-
            float v = id(zieltemperatur_input).state;
            if (!std::isfinite(v)) return std::string("Soll: —");
            char b[24];
            snprintf(b, sizeof(b), "Soll: %.1f°C", v);
            return std::string(b);

      - lvgl.label.update:
          id: lbl_hero_mixer
          text: !lambda |-
            const float v = id(mischer_position);
            if (!std::isfinite(v)) return std::string("Mischer: —");
            char b[24];
            snprintf(b, sizeof(b), "Mischer: %.0f%%", v);
            return std::string(b);

      - lvgl.label.update:
          id: lbl_card_outdoor
          text: !lambda |-
            if (!std::isfinite(id(outdoor).state)) return std::string("—");
            char b[16];
            snprintf(b, sizeof(b), "%.1f°C", id(outdoor).state);
            return std::string(b);

      - lvgl.label.update:
          id: lbl_card_kessel
          text: !lambda |-
            if (!std::isfinite(id(kesseltemperatur).state)) return std::string("—");
            char b[16];
            snprintf(b, sizeof(b), "%.1f°C", id(kesseltemperatur).state);
            return std::string(b);

      - lvgl.label.update:
          id: lbl_card_ww
          text: !lambda |-
            if (!std::isfinite(id(temp8).state)) return std::string("—");
            char b[16];
            snprintf(b, sizeof(b), "%.1f°C", id(temp8).state);
            return std::string(b);

      - lvgl.label.update:
          id: lbl_card_vlsoll
          text: !lambda |-
            const float v = id(vessel_soll);  // global float (optional in your project)
            if (!std::isfinite(v)) return std::string("—");
            char b[16];
            snprintf(b, sizeof(b), "%.1f°C", v);
            return std::string(b);

      # ---------- Control: robust mode display + setpoints ----------
      - lvgl.label.update:
          id: lbl_mode_state
          text: !lambda |-
            const std::string m = id(heizmodus_select).state;
            if      (m == "auto")   return std::string("Modus: Auto");
            else if (m == "summer") return std::string("Modus: Sommer");
            else if (m == "winter") return std::string("Modus: Winter");
            else if (m == "pool")   return std::string("Modus: Pool");
            return std::string("Modus: ?");

      - lvgl.label.update:
          id: lbl_ctl_vl
          text: !lambda |-
            float v = id(zieltemperatur_input).state;
            if (!std::isfinite(v)) return std::string("—");
            char b[16];
            snprintf(b, sizeof(b), "%.1f°C", v);
            return std::string(b);

      - lvgl.label.update:
          id: lbl_ctl_ww
          text: !lambda |-
            float v = id(warmwasser_zieltemperatur_input).state;
            if (!std::isfinite(v)) return std::string("—");
            char b[16];
            snprintf(b, sizeof(b), "%.1f°C", v);
            return std::string(b);

      - lvgl.label.update:
          id: lbl_wifi_icon
          text: !lambda |-
            const float r = id(ui_wifi_rssi).state;
            if (!std::isfinite(r)) return std::string("\U000F092D"); // off
            if (r >= -55) return std::string("\U000F0928"); // 4
            if (r >= -67) return std::string("\U000F0925"); // 3
            if (r >= -80) return std::string("\U000F0922"); // 2
            return std::string("\U000F091F");               // 1

      # ---------- Pool (optional states) ----------
      - lvgl.label.update:
          id: lbl_pool_fp
          text: !lambda |-
            return id(filter_pumpe_enable_dac).state ? std::string("EIN") : std::string("AUS");

      - lvgl.label.update:
          id: lbl_pool_speed
          text: !lambda |-
            float v = id(filter_pumpe_speed_pct).state;
            if (!std::isfinite(v)) return std::string("—");
            char b[16];
            snprintf(b, sizeof(b), "%.0f%%", v);
            return std::string(b);

      - lvgl.label.update:
          id: lbl_pool_dos
          text: !lambda |-
            return id(dosierung_enable).state ? std::string("EIN") : std::string("AUS");

      # ---------- System ----------
      - lvgl.label.update:
          id: lbl_sys_uptime
          text: !lambda |-
            float up = id(ui_uptime_s).state;
            if (!std::isfinite(up) || up < 0) return std::string("—");
            uint32_t s = (uint32_t) up;
            uint32_t h = s / 3600;
            uint32_t m = (s % 3600) / 60;
            char b[20];
            snprintf(b, sizeof(b), "%uh %um", (unsigned)h, (unsigned)m);
            return std::string(b);

      - lvgl.label.update:
          id: lbl_sys_loop
          text: !lambda |-
            char b[20];
            snprintf(b, sizeof(b), "%lu ms", (unsigned long)App.get_loop_interval());
            return std::string(b);

      - lvgl.label.update:
          id: lbl_sys_heap
          text: !lambda |-
            char b[20];
            snprintf(b, sizeof(b), "%u KB", (unsigned)(ESP.getFreeHeap() / 1024));
            return std::string(b);

      - lvgl.label.update:
          id: lbl_sys_ip
          text: !lambda |-
            if (!WiFi.isConnected()) return std::string("—");
            auto ip = WiFi.localIP();
            char b[20];
            snprintf(b, sizeof(b), "%u.%u.%u.%u", ip[0], ip[1], ip[2], ip[3]);
            return std::string(b);

      - lvgl.label.update:
          id: lbl_sys_reset
          text: !lambda |-
            esp_reset_reason_t rr = esp_reset_reason();
            const char* s = "UNKNOWN";
            switch (rr) {
              case ESP_RST_POWERON:   s = "POWERON"; break;
              case ESP_RST_SW:        s = "SW"; break;
              case ESP_RST_PANIC:     s = "PANIC"; break;
              case ESP_RST_INT_WDT:   s = "INT_WDT"; break;
              case ESP_RST_TASK_WDT:  s = "TASK_WDT"; break;
              case ESP_RST_WDT:       s = "WDT"; break;
              case ESP_RST_DEEPSLEEP: s = "SLEEP"; break;
              case ESP_RST_BROWNOUT:  s = "BROWNOUT"; break;
              default: break;
            }
            return std::string(s);
      - lvgl.label.update:
          id: lbl_mode_state
          text: !lambda |-
            const std::string m = id(heizmodus_select).state;
            if      (m == "auto")   return std::string("Modus: Auto");
            else if (m == "summer") return std::string("Modus: Sommer");
            else if (m == "winter") return std::string("Modus: Winter");
            else if (m == "pool")   return std::string("Modus: Pool");
            return std::string("Modus: ?");

      # --- Apply button highlight (NO matrix.update needed) ---
      - if:
          condition:
            lambda: 'return id(heizmodus_select).state == "auto";'
          then:
            - lvgl.button.update: { id: btn_mode_auto, styles: mode_btn_active }
            - lvgl.label.update:  { id: txt_mode_auto, styles: mode_txt_active }
          else:
            - lvgl.button.update: { id: btn_mode_auto, styles: mode_btn }
            - lvgl.label.update:  { id: txt_mode_auto, styles: mode_txt }

      - if:
          condition:
            lambda: 'return id(heizmodus_select).state == "summer";'
          then:
            - lvgl.button.update: { id: btn_mode_summer, styles: mode_btn_active }
            - lvgl.label.update:  { id: txt_mode_summer, styles: mode_txt_active }
          else:
            - lvgl.button.update: { id: btn_mode_summer, styles: mode_btn }
            - lvgl.label.update:  { id: txt_mode_summer, styles: mode_txt }

      - if:
          condition:
            lambda: 'return id(heizmodus_select).state == "winter";'
          then:
            - lvgl.button.update: { id: btn_mode_winter, styles: mode_btn_active }
            - lvgl.label.update:  { id: txt_mode_winter, styles: mode_txt_active }
          else:
            - lvgl.button.update: { id: btn_mode_winter, styles: mode_btn }
            - lvgl.label.update:  { id: txt_mode_winter, styles: mode_txt }

      - if:
          condition:
            lambda: 'return id(heizmodus_select).state == "pool";'
          then:
            - lvgl.button.update: { id: btn_mode_pool, styles: mode_btn_active }
            - lvgl.label.update:  { id: txt_mode_pool, styles: mode_txt_active }
          else:
            - lvgl.button.update: { id: btn_mode_pool, styles: mode_btn }
            - lvgl.label.update:  { id: txt_mode_pool, styles: mode_txt }

# ---------------- LVGL "Product" theme ----------------
lvgl:
  displays:
    - tft

  touchscreens:
    - touchscreen_id: touch

  color_depth: 16
  buffer_size: 10%
  disp_bg_color: 0x070B12
  default_font: ui_font_m
  log_level: WARN

  theme:
    label:
      text_color: 0xE7EEF9
    button:
      bg_color: 0x132033
      bg_opa: COVER
      radius: 14
      border_width: 1
      border_color: 0x22324B
      pressed:
        bg_color: 0x1A2A42
    buttonmatrix:
      bg_opa: TRANSP
      border_width: 0
      pad_all: 0
      items:
        bg_color: 0x0F1726
        bg_opa: COVER
        border_width: 1
        border_color: 0x22324B
        text_color: 0x9FB0C8
        pressed:
          bg_color: 0x1A2A42
          text_color: 0xFFFFFF
        checked:
          bg_color: 0x2B6FFF
          text_color: 0xFFFFFF

  style_definitions:
    - id: hdr
      bg_color: 0x0B1220
      bg_opa: COVER
      border_width: 0
      pad_left: 10
      pad_right: 10
      pad_top: 6
      pad_bottom: 6

    - id: chip
      bg_color: 0x0F1726
      bg_opa: COVER
      radius: 12
      pad_left: 8
      pad_right: 8
      pad_top: 4
      pad_bottom: 4
      border_width: 1
      border_color: 0x22324B

    - id: card
      bg_color: 0x0B1424
      bg_opa: COVER
      radius: 18
      pad_left: 12
      pad_right: 12
      pad_top: 10
      pad_bottom: 10
      border_width: 1
      border_color: 0x22324B

    - id: hero
      bg_color: 0x0D1A2F
      bg_opa: COVER
      radius: 20
      pad_left: 14
      pad_right: 14
      pad_top: 12
      pad_bottom: 10
      border_width: 1
      border_color: 0x2B6FFF

    - id: title
      text_color: 0x9FB0C8
      text_font: ui_font_s

    - id: vxl
      text_color: 0xFFFFFF
      text_font: ui_font_xl

    - id: vl
      text_color: 0xFFFFFF
      text_font: ui_font_l

    - id: vm
      text_color: 0xE7EEF9
      text_font: ui_font_m

    - id: nav
      bg_color: 0x070B12
      bg_opa: COVER
      border_width: 0
      pad_all: 4

    - id: mode_btn
      bg_color: 0x0F1726
      bg_opa: COVER
      radius: 14
      border_width: 1
      border_color: 0x22324B
      pad_left: 8
      pad_right: 8
      pad_top: 6
      pad_bottom: 6

    - id: mode_btn_active
      bg_color: 0x2B6FFF
      bg_opa: COVER
      radius: 14
      border_width: 1
      border_color: 0x2B6FFF
      pad_left: 8
      pad_right: 8
      pad_top: 6
      pad_bottom: 6

    - id: mode_txt
      text_color: 0x9FB0C8
      text_font: ui_font_m

    - id: mode_txt_active
      text_color: 0xFFFFFF
      text_font: ui_font_m

    - id: wifi_icon
      text_font: mdi_wifi_24
      text_color: 0xE7EEF9
  # Bottom nav (fixed)
  top_layer:
    widgets:
      - obj:
          align: bottom_mid
          width: 240
          height: 52
          styles: nav
          widgets:
            - buttonmatrix:
                id: nav_matrix
                one_checked: true
                width: 240
                height: 44
                pad_row: 0
                pad_column: 6
                rows:
                  - buttons:
                      - id: nav_status
                        text: "Status"
                        control:
                          checkable: true
                          checked: true
                        on_value:
                          then:
                            - if:
                                condition:
                                  lambda: "return x;"
                                then:
                                  - lvgl.page.show: page_heat_status

                      - id: nav_control
                        text: "Control"
                        control:
                          checkable: true
                        on_value:
                          then:
                            - if:
                                condition:
                                  lambda: "return x;"
                                then:
                                  - lvgl.page.show: page_heat_control

                      - id: nav_pool
                        text: "Pool"
                        control:
                          checkable: true
                        on_value:
                          then:
                            - if:
                                condition:
                                  lambda: "return x;"
                                then:
                                  - lvgl.page.show: page_pool

                      - id: nav_system
                        text: "System"
                        control:
                          checkable: true
                        on_value:
                          then:
                            - if:
                                condition:
                                  lambda: "return x;"
                                then:
                                  - lvgl.page.show: page_system

  pages:
    # Geometry:
    # header: y=0..43 (44px)
    # content: y=48..263 (216px)
    # nav: y=268..319 (52px)

    # =========================
    # STATUS (hero + 2x2 cards)
    # =========================
    - id: page_heat_status
      widgets:
        # Header
        - obj:
            align: top_left
            x: 0
            y: 0
            width: 240
            height: 44
            styles: hdr
            widgets:
              - label:
                  text: "Heizung"
                  align: left_mid
                  styles: vm
              - label:
                  id: lbl_wifi_icon
                  text: "\U000F092D"   # wifi-strength-off default
                  align: right_mid
                  x: -8
                  styles: wifi_icon
        # Hero card (224x92)
        - obj:
            align: top_left
            x: 8
            y: 48
            width: 224
            height: 92
            styles: hero
            widgets:
              - label:
                  text: "Vorlauf"
                  align: top_left
                  styles: title
              - label:
                  id: lbl_hero_vl
                  text: "—"
                  align: left_mid
                  y: 6
                  styles: vxl
              - label:
                  id: lbl_hero_vl_soll
                  text: "Soll: —"
                  align: bottom_left
                  styles: title
              - label:
                  id: lbl_hero_mixer
                  text: "Mischer: —"
                  align: bottom_right
                  styles: title

        # Cards row 1 (2x 109x56)
        - obj:
            align: top_left
            x: 8
            y: 146
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Außen", styles: title, align: top_left }
              - label: { id: lbl_card_outdoor, text: "—", styles: vl, align: bottom_left }

        - obj:
            align: top_left
            x: 123
            y: 146
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Kessel", styles: title, align: top_left }
              - label: { id: lbl_card_kessel, text: "—", styles: vl, align: bottom_left }

        # Cards row 2 (2x 109x56)
        - obj:
            align: top_left
            x: 8
            y: 208
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Warmwasser", styles: title, align: top_left }
              - label: { id: lbl_card_ww, text: "—", styles: vl, align: bottom_left }

        - obj:
            align: top_left
            x: 123
            y: 208
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "VL Soll", styles: title, align: top_left }
              - label: { id: lbl_card_vlsoll, text: "—", styles: vl, align: bottom_left }

    # =========================
    # CONTROL (mode pill + 2 setpoint cards)
    # Modus display FIXED: label + checked highlight
    # =========================
    - id: page_heat_control
      widgets:
        - obj:
            align: top_left
            x: 0
            y: 0
            width: 240
            height: 44
            styles: hdr
            widgets:
              - label:
                  text: "Control"
                  align: left_mid
                  styles: vm
              - obj:
                  align: right_mid
                  width: 110
                  height: 26
                  styles: chip
                  widgets:
                    - label:
                        id: lbl_mode_state
                        text: "Modus: —"
                        align: center
                        styles: title

        # Mode card
        - obj:
            align: top_left
            x: 8
            y: 48
            width: 224
            height: 78
            styles: card
            widgets:
              - label:
                  text: "Heizmodus"
                  align: top_left
                  styles: title

              # Row of 4 mode buttons (fixed sizes, no overlap)
              - button:
                  id: btn_mode_auto
                  align: top_left
                  x: 0
                  y: 26
                  width: 52
                  height: 44
                  styles: mode_btn
                  on_press:
                    then:
                      - select.set: { id: heizmodus_select, option: "auto" }
                  widgets:
                    - label: { id: txt_mode_auto, text: "Auto", align: center, styles: mode_txt }

              - button:
                  id: btn_mode_summer
                  align: top_left
                  x: 58
                  y: 26
                  width: 52
                  height: 44
                  styles: mode_btn
                  on_press:
                    then:
                      - select.set: { id: heizmodus_select, option: "summer" }
                  widgets:
                    - label: { id: txt_mode_summer, text: "Som", align: center, styles: mode_txt }

              - button:
                  id: btn_mode_winter
                  align: top_left
                  x: 116
                  y: 26
                  width: 52
                  height: 44
                  styles: mode_btn
                  on_press:
                    then:
                      - select.set: { id: heizmodus_select, option: "winter" }
                  widgets:
                    - label: { id: txt_mode_winter, text: "Win", align: center, styles: mode_txt }

              - button:
                  id: btn_mode_pool
                  align: top_left
                  x: 174
                  y: 26
                  width: 50
                  height: 44
                  styles: mode_btn
                  on_press:
                    then:
                      - select.set: { id: heizmodus_select, option: "pool" }
                  widgets:
                    - label: { id: txt_mode_pool, text: "Pool", align: center, styles: mode_txt }


        # Vorlauf Soll (224x70)
        - obj:
            align: top_left
            x: 8
            y: 120
            width: 224
            height: 70
            styles: card
            widgets:
              - label: { text: "Vorlauf Soll", styles: title, align: top_left }
              - label: { id: lbl_ctl_vl, text: "—", styles: vl, align: left_mid, y: 10 }
              - button:
                  width: 56
                  height: 44
                  align: right_mid
                  x: -64
                  on_press:
                    then:
                      - script.execute: { id: ui_vl_nudge, delta: -0.5 }
                  widgets:
                    - label: { text: "–", align: center, styles: vm }
              - button:
                  width: 56
                  height: 44
                  align: right_mid
                  x: 0
                  on_press:
                    then:
                      - script.execute: { id: ui_vl_nudge, delta: 0.5 }
                  widgets:
                    - label: { text: "+", align: center, styles: vm }

        # WW Soll (224x70)
        - obj:
            align: top_left
            x: 8
            y: 196
            width: 224
            height: 70
            styles: card
            widgets:
              - label: { text: "WW Soll", styles: title, align: top_left }
              - label: { id: lbl_ctl_ww, text: "—", styles: vl, align: left_mid, y: 10 }
              - button:
                  width: 56
                  height: 44
                  align: right_mid
                  x: -64
                  on_press:
                    then:
                      - script.execute: { id: ui_ww_nudge, delta: -0.5 }
                  widgets:
                    - label: { text: "–", align: center, styles: vm }
              - button:
                  width: 56
                  height: 44
                  align: right_mid
                  x: 0
                  on_press:
                    then:
                      - script.execute: { id: ui_ww_nudge, delta: 0.5 }
                  widgets:
                    - label: { text: "+", align: center, styles: vm }

    # =========================
    # POOL (simple, product-ish)
    # =========================
    - id: page_pool
      widgets:
        - obj:
            align: top_left
            x: 0
            y: 0
            width: 240
            height: 44
            styles: hdr
            widgets:
              - label: { text: "Pool", align: left_mid, styles: vm }

        - obj:
            align: top_left
            x: 8
            y: 48
            width: 224
            height: 104
            styles: card
            widgets:
              - label: { text: "Filterpumpe", styles: title, align: top_left }
              - label: { text: "Status:", styles: title, align: top_left, y: 18 }
              - label: { id: lbl_pool_fp, text: "—", styles: vm, align: top_left, x: 58, y: 16 }
              - label: { text: "Speed:", styles: title, align: top_left, y: 40 }
              - label: { id: lbl_pool_speed, text: "—", styles: vm, align: top_left, x: 58, y: 38 }
              - button:
                  width: 68
                  height: 44
                  align: bottom_left
                  on_press:
                    then:
                      - script.execute: ui_toggle_filterpump
                  widgets:
                    - label: { text: "Toggle", align: center, styles: vm }
              - button:
                  width: 68
                  height: 44
                  align: bottom_mid
                  x: -36
                  on_press:
                    then:
                      - script.execute: { id: ui_filterpump_speed_nudge, delta: -5 }
                  widgets:
                    - label: { text: "-5%", align: center, styles: vm }
              - button:
                  width: 68
                  height: 44
                  align: bottom_mid
                  x: 36
                  on_press:
                    then:
                      - script.execute: { id: ui_filterpump_speed_nudge, delta: 5 }
                  widgets:
                    - label: { text: "+5%", align: center, styles: vm }

        - obj:
            align: top_left
            x: 8
            y: 158
            width: 224
            height: 108
            styles: card
            widgets:
              - label: { text: "Dosierung", styles: title, align: top_left }
              - label: { text: "Status:", styles: title, align: top_left, y: 18 }
              - label: { id: lbl_pool_dos, text: "—", styles: vm, align: top_left, x: 58, y: 16 }
              - button:
                  width: 224
                  height: 44
                  align: bottom_left
                  on_press:
                    then:
                      - script.execute: ui_toggle_dosierung
                  widgets:
                    - label: { text: "Toggle", align: center, styles: vm }

    # =========================
    # SYSTEM (compact + product feel)
    # =========================
    - id: page_system
      widgets:
        - obj:
            align: top_left
            x: 0
            y: 0
            width: 240
            height: 44
            styles: hdr
            widgets:
              - label: { text: "System", align: left_mid, styles: vm }

        # 2x2 mini cards (109x56)
        - obj:
            align: top_left
            x: 8
            y: 48
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Uptime", styles: title, align: top_left }
              - label: { id: lbl_sys_uptime, text: "—", styles: vm, align: bottom_left }

        - obj:
            align: top_left
            x: 123
            y: 48
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Loop", styles: title, align: top_left }
              - label: { id: lbl_sys_loop, text: "—", styles: vm, align: bottom_left }

        - obj:
            align: top_left
            x: 8
            y: 110
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Heap", styles: title, align: top_left }
              - label: { id: lbl_sys_heap, text: "—", styles: vm, align: bottom_left }

        - obj:
            align: top_left
            x: 123
            y: 110
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "IP", styles: title, align: top_left }
              - label: { id: lbl_sys_ip, text: "—", styles: title, align: bottom_left }

        - obj:
            align: top_left
            x: 8
            y: 172
            width: 224
            height: 54
            styles: card
            widgets:
              - label: { text: "Reset Reason", styles: title, align: top_left }
              - label: { id: lbl_sys_reset, text: "—", styles: vm, align: bottom_left }

        - button:
            align: top_left
            x: 8
            y: 232
            width: 224
            height: 34
            on_press:
              then:
                - button.press: restart_button
            widgets:
              - label: { text: "Restart", align: center, styles: vm }
