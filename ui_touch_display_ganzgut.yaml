# ui_touch_display.yaml - LVGL UI (ESPHome 2025.7.5) - Portrait 240x320
# Safe include: NO spi/debug/restart_button/ui_* scripts redefinitions.

globals:
  - id: ui_ready
    type: bool
    restore_value: no
    initial_value: "false"

  - id: ui_busy
    type: bool
    restore_value: no
    initial_value: "false"

  - id: ui_mode_cache
    type: int
    restore_value: no
    initial_value: "-1"

  - id: ui_mode_dirty
    type: bool
    restore_value: no
    initial_value: "false"

  - id: ui_dirty
    type: bool
    restore_value: no
    initial_value: "true"

  - id: ui_last_vl
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_out
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_kessel
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_rl
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_ww
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_mixer
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_curve_level
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_curve_slope
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_wifi_state
    type: int
    restore_value: no
    initial_value: "-99"
  - id: ui_last_ctl_vl
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_ctl_ww
    type: float
    restore_value: no
    initial_value: "NAN"

  # pump states cached as 0/1 floats
  - id: ui_last_pump_hz
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_pump_ww
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_pump_hz_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_pump_ww_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_vl_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_out_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_kessel_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_ww_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_level_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_slope_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_wifi_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_ctl_vl_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_ctl_ww_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_pool_fp_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_pool_speed_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_pool_dos_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_last_brenner_state
    type: int
    restore_value: no
    initial_value: "-1"
  - id: ui_brenner_dirty
    type: bool
    restore_value: no
    initial_value: "false"
  - id: ui_page
    type: int
    restore_value: no
    initial_value: "0"   # 0=status, 1=control, 2=pool, 3=system
  - id: ui_page_dirty
    type: bool
    restore_value: no
    initial_value: "true"   # on boot: force initial draw



  # Pool cache (damit Pool-Seite "dirty" werden kann)
  - id: ui_last_pool_fp
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_pool_speed
    type: float
    restore_value: no
    initial_value: "NAN"
  - id: ui_last_pool_dos
    type: float
    restore_value: no
    initial_value: "NAN"

esphome:
  on_boot:
    priority: -100
    then:
      - delay: 10000ms
      - lambda: |-
          id(ui_ready) = true;
      - script.execute: ui_refresh_fast
      - script.execute: ui_refresh_slow


# ---------------- Fonts ----------------
font:
  - file: "gfonts://Roboto"
    id: ui_font_xl
    size: 30
    glyphs: ' 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzÄÖÜäöüß°%:+-–·±().,/_'
  - file: "gfonts://Roboto"
    id: ui_font_l
    size: 22
    glyphs: ' 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzÄÖÜäöüß°%:+-–·±().,/_'
  - file: "gfonts://Roboto"
    id: ui_font_m
    size: 17
    glyphs: ' 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzÄÖÜäöüß°%:+-–·±().,/_'
  - file: "gfonts://Roboto"
    id: ui_font_s
    size: 13
    glyphs: ' 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzÄÖÜäöüß°%:+-–·±().,/_'
  - file: "materialdesignicons-webfont.ttf"
    id: mdi_wifi_24
    size: 24
    glyphs:
      - "\U000F091F"
      - "\U000F0922"
      - "\U000F0925"
      - "\U000F0928"
      - "\U000F092D"


# ---------------- Display (uses your existing spi_tft) ----------------
display:
  - platform: ili9xxx
    id: tft
    model: ili9341
    spi_id: spi_tft
    cs_pin: GPIO8
    dc_pin: GPIO48
    reset_pin: GPIO14
    invert_colors: false
    data_rate: 40MHz
    rotation: 0
    update_interval: never


# ---------------- Touch (uses your existing spi_touch) ----------------
touchscreen:
  - platform: xpt2046
    id: touch
    spi_id: spi_touch
    cs_pin: GPIO38
    interrupt_pin:
      number: GPIO47
      mode: INPUT_PULLUP
      inverted: true
    display: tft
    update_interval: 150ms
    threshold: 400

    calibration:
      x_min: 392
      x_max: 3725
      y_min: 423
      y_max: 3791

    transform:
      swap_xy: false
      mirror_x: false
      mirror_y: true


# ---------------- Internal helpers ----------------
sensor:
  - platform: uptime
    id: ui_uptime_s
    update_interval: 10s
    internal: true

  - platform: wifi_signal
    id: ui_wifi_rssi
    update_interval: 10s
    internal: true


interval:
  - interval: 2s
    startup_delay: 2s
    then:
      - if:
          condition:
            lambda: 'return id(ui_ready) && !id(ui_busy);'
          then:
            - script.execute: ui_refresh_fast

  - interval: 15s
    startup_delay: 9s
    then:
      - if:
          condition:
            lambda: 'return id(ui_ready) && !id(ui_busy);'
          then:
            - script.execute: ui_refresh_slow


# ---------------- UI refresh ----------------
script:
  - id: ui_refresh_fast
    mode: restart
    then:
      # guard
      - if:
          condition:
            lambda: 'return !id(ui_ready) || id(ui_busy);'
          then:
            - lambda: 'return;'
          else:
            - lambda: 'id(ui_busy) = true;'

      # heap guard (dbg_heap_free_bytes exists in your main yaml)
      - if:
          condition:
            lambda: |-
              return isfinite(id(dbg_heap_free_bytes).state) && id(dbg_heap_free_bytes).state < 30000;
          then:
            - lambda: 'id(ui_busy) = false; return;'

      # detect mode change once
      - lambda: |-
          int new_mode = -1;
          const std::string m = id(heizmodus_select).state;
          if      (m == "auto")   new_mode = 0;
          else if (m == "summer") new_mode = 1;
          else if (m == "winter") new_mode = 2;
          else if (m == "pool")   new_mode = 3;

          bool mode_dirty = (new_mode != id(ui_mode_cache));
          id(ui_mode_dirty) = mode_dirty;
          if (mode_dirty) id(ui_mode_cache) = new_mode;

      # dirty detection
      - lambda: |-
          auto chg = [&](float &last, float cur, float eps)->bool{
            const bool cfin = std::isfinite(cur);
            const bool lfin = std::isfinite(last);
            if (!cfin && !lfin) return false;
            if (cfin != lfin) { last = cur; return true; }
            if (fabsf(cur - last) >= eps) { last = cur; return true; }
            return false;
          };

          // --- Status (page 0) ---
          bool d_status = false;
          const bool vl_dirty = chg(id(ui_last_vl),     id(vorlauftemperatur).state,    0.1f);
          const bool k_dirty  = chg(id(ui_last_kessel), id(kesseltemperatur).state,     0.1f);
          const bool ww_dirty = chg(id(ui_last_ww),     id(warmwassertemperatur).state, 0.1f);
          const bool out_dirty = chg(id(ui_last_out),   id(outdoor).state,              0.1f);
          const bool level_dirty = chg(id(ui_last_curve_level), id(curve_level),        0.1f);
          const bool slope_dirty = chg(id(ui_last_curve_slope), id(curve_slope),        0.01f);
          id(ui_vl_dirty) = vl_dirty;
          id(ui_kessel_dirty) = k_dirty;
          id(ui_ww_dirty) = ww_dirty;
          id(ui_out_dirty) = out_dirty;
          id(ui_level_dirty) = level_dirty;
          id(ui_slope_dirty) = slope_dirty;
          d_status |= vl_dirty;
          d_status |= k_dirty;
          d_status |= ww_dirty;
          d_status |= out_dirty;
          d_status |= level_dirty;
          d_status |= slope_dirty;

          const float phz = id(heizkreispumpe).state ? 1.0f : 0.0f;
          const float pww = id(warmwasserpumpe).state ? 1.0f : 0.0f;
          const bool hz_dirty = chg(id(ui_last_pump_hz), phz, 0.5f);
          const bool pww_dirty = chg(id(ui_last_pump_ww), pww, 0.5f);
          id(ui_pump_hz_dirty) = hz_dirty;
          id(ui_pump_ww_dirty) = pww_dirty;
          d_status |= hz_dirty;
          d_status |= pww_dirty;

          int b_state = 0;
          if (id(brennerbetrieb_bz).state) b_state = 2;
          else if (id(brenner).state) b_state = 1;
          const bool b_dirty = (b_state != id(ui_last_brenner_state));
          if (b_dirty) id(ui_last_brenner_state) = b_state;
          id(ui_brenner_dirty) = b_dirty;
          d_status |= b_dirty;

          int wifi_state = -1;
          const float r = id(ui_wifi_rssi).state;
          if (std::isfinite(r)) {
            if (r >= -55) wifi_state = 4;
            else if (r >= -67) wifi_state = 3;
            else if (r >= -80) wifi_state = 2;
            else wifi_state = 1;
          }
          const bool wifi_dirty = (wifi_state != id(ui_last_wifi_state));
          if (wifi_dirty) id(ui_last_wifi_state) = wifi_state;
          id(ui_wifi_dirty) = wifi_dirty;
          d_status |= wifi_dirty;

          // --- Control (page 1) ---
          bool d_control = false;
          const bool ctl_vl_dirty = chg(id(ui_last_ctl_vl), id(zieltemperatur_input).state, 0.1f);
          const bool ctl_ww_dirty = chg(id(ui_last_ctl_ww), id(warmwasser_zieltemperatur_input).state, 0.1f);
          id(ui_ctl_vl_dirty) = ctl_vl_dirty;
          id(ui_ctl_ww_dirty) = ctl_ww_dirty;
          d_control |= id(ui_mode_dirty);
          d_control |= ctl_vl_dirty;
          d_control |= ctl_ww_dirty;

          // --- Pool (page 2) ---
          bool d_pool = false;
          const float fp = id(filter_pumpe_enable_dac).state ? 1.0f : 0.0f;
          const float sp = id(filter_pumpe_speed_pct).state;  // bleibt NAN wenn ungültig
          const float ds = id(dosierung_enable).state ? 1.0f : 0.0f;
          const bool fp_dirty = chg(id(ui_last_pool_fp), fp, 0.5f);
          const bool sp_dirty = chg(id(ui_last_pool_speed), sp, 0.5f);
          const bool dos_dirty = chg(id(ui_last_pool_dos), ds, 0.5f);
          id(ui_pool_fp_dirty) = fp_dirty;
          id(ui_pool_speed_dirty) = sp_dirty;
          id(ui_pool_dos_dirty) = dos_dirty;
          d_pool |= fp_dirty;
          d_pool |= sp_dirty;
          d_pool |= dos_dirty;

          // --- Fast Updates je nach aktiver Seite ---
          bool d = false;
          if      (id(ui_page) == 0) d = d_status;
          else if (id(ui_page) == 1) d = d_control;
          else if (id(ui_page) == 2) d = d_pool;
          else if (id(ui_page) == 3) d = false;   // System wird primär von slow gepflegt

          // Page-Wechsel soll immer einmal rendern
          if (id(ui_page_dirty)) d = true;


          id(ui_dirty) = d;

      - if:
          condition:
            lambda: 'return !id(ui_dirty);'
          then:
            - lambda: 'id(ui_busy) = false; return;'

      # ---------- STATUS page (0) ----------
      - if:
          condition:
            lambda: "return id(ui_page) == 0;"
          then:
            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_vl_dirty);"
                then:
                  - lvgl.label.update:
                      id: lbl_card_vl
                      text: !lambda |-
                        if (!std::isfinite(id(vorlauftemperatur).state)) return std::string("-");
                        char b[16]; snprintf(b, sizeof(b), "%.1f°C", id(vorlauftemperatur).state);
                        return std::string(b);

            - delay: 2ms

            # ---------- Header pumps ----------
            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_pump_hz_dirty);"
                then:
                  - lvgl.label.update: { id: lbl_pump_hz, text: "H" }
                  - if:
                      condition:
                        lambda: "return id(heizkreispumpe).state;"
                      then:
                        - lvgl.label.update: { id: lbl_pump_hz, styles: pump_on }
                      else:
                        - lvgl.label.update: { id: lbl_pump_hz, styles: pump_off }

            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_pump_ww_dirty);"
                then:
                  - lvgl.label.update: { id: lbl_pump_ww, text: "W" }
                  - if:
                      condition:
                        lambda: "return id(warmwasserpumpe).state;"
                      then:
                        - lvgl.label.update: { id: lbl_pump_ww, styles: pump_on }
                      else:
                        - lvgl.label.update: { id: lbl_pump_ww, styles: pump_off }

            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_brenner_dirty);"
                then:
                  - lvgl.label.update: { id: lbl_brenner, text: "B" }
                  - if:
                      condition:
                        lambda: "return id(brennerbetrieb_bz).state;"
                      then:
                        - lvgl.label.update: { id: lbl_brenner, styles: burner_hot }
                      else:
                        - if:
                            condition:
                              lambda: "return id(brenner).state;"
                            then:
                              - lvgl.label.update: { id: lbl_brenner, styles: burner_on }
                            else:
                              - lvgl.label.update: { id: lbl_brenner, styles: burner_off }

            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_wifi_dirty);"
                then:
                  - lvgl.label.update:
                      id: lbl_wifi_icon
                      text: !lambda |-
                        const float r = id(ui_wifi_rssi).state;
                        if (!std::isfinite(r)) return std::string("\U000F092D");
                        if (r >= -55) return std::string("\U000F0928");
                        if (r >= -67) return std::string("\U000F0925");
                        if (r >= -80) return std::string("\U000F0922");
                        return std::string("\U000F091F");

            - delay: 2ms

            # ---------- Cards ----------
            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_out_dirty);"
                then:
                  - lvgl.label.update:
                      id: lbl_card_outdoor
                      text: !lambda |-
                        if (!std::isfinite(id(outdoor).state)) return std::string("-");
                        char b[16]; snprintf(b, sizeof(b), "%.1f°C", id(outdoor).state);
                        return std::string(b);

            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_kessel_dirty);"
                then:
                  - lvgl.label.update:
                      id: lbl_card_kessel
                      text: !lambda |-
                        if (!std::isfinite(id(kesseltemperatur).state)) return std::string("-");
                        char b[16]; snprintf(b, sizeof(b), "%.1f°C", id(kesseltemperatur).state);
                        return std::string(b);

            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_ww_dirty);"
                then:
                  - lvgl.label.update:
                      id: lbl_card_ww
                      text: !lambda |-
                        if (!std::isfinite(id(warmwassertemperatur).state)) return std::string("-");
                        char b[16]; snprintf(b, sizeof(b), "%.1f°C", id(warmwassertemperatur).state);
                        return std::string(b);

            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_level_dirty);"
                then:
                  - lvgl.label.update:
                      id: lbl_card_level
                      text: !lambda |-
                        if (!std::isfinite(id(curve_level))) return std::string("-");
                        char b[16]; snprintf(b, sizeof(b), "%.1f", id(curve_level));
                        return std::string(b);

            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_slope_dirty);"
                then:
                  - lvgl.label.update:
                      id: lbl_card_slope
                      text: !lambda |-
                        if (!std::isfinite(id(curve_slope))) return std::string("-");
                        char b[16]; snprintf(b, sizeof(b), "%.2f", id(curve_slope));
                        return std::string(b);

            - delay: 2ms

      # ---------- CONTROL page (1) ----------
      - if:
          condition:
            lambda: "return id(ui_page) == 1;"
          then:
            # ---------- Control texts ----------
            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_mode_dirty);"
                then:
                  - lvgl.label.update:
                      id: lbl_mode_state
                      text: !lambda |-
                        const std::string m = id(heizmodus_select).state;
                        if      (m == "auto")   return std::string("Modus: Auto");
                        else if (m == "summer") return std::string("Modus: Sommer");
                        else if (m == "winter") return std::string("Modus: Winter");
                        else if (m == "pool")   return std::string("Modus: Pool");
                        return std::string("Modus: ?");

            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_ctl_vl_dirty);"
                then:
                  - lvgl.label.update:
                      id: lbl_ctl_vl
                      text: !lambda |-
                        float v = id(zieltemperatur_input).state;
                        if (!std::isfinite(v)) return std::string("-");
                        char b[16]; snprintf(b, sizeof(b), "%.1f°C", v);
                        return std::string(b);

            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_ctl_ww_dirty);"
                then:
                  - lvgl.label.update:
                      id: lbl_ctl_ww
                      text: !lambda |-
                        float v = id(warmwasser_zieltemperatur_input).state;
                        if (!std::isfinite(v)) return std::string("-");
                        char b[16]; snprintf(b, sizeof(b), "%.1f°C", v);
                        return std::string(b);

            - delay: 2ms

            # ---------- Mode highlight only on change ----------
            - if:
                condition:
                  lambda: |-
                    return id(ui_mode_dirty) &&
                           isfinite(id(dbg_heap_free_bytes).state) &&
                           id(dbg_heap_free_bytes).state > 40000;
                then:
                  - if:
                      condition:
                        lambda: 'return id(heizmodus_select).state == "auto";'
                      then:
                        - lvgl.button.update: { id: btn_mode_auto, styles: mode_btn_active }
                        - lvgl.label.update:  { id: txt_mode_auto, styles: mode_txt_active }
                      else:
                        - lvgl.button.update: { id: btn_mode_auto, styles: mode_btn }
                        - lvgl.label.update:  { id: txt_mode_auto, styles: mode_txt }

                  - if:
                      condition:
                        lambda: 'return id(heizmodus_select).state == "summer";'
                      then:
                        - lvgl.button.update: { id: btn_mode_summer, styles: mode_btn_active }
                        - lvgl.label.update:  { id: txt_mode_summer, styles: mode_txt_active }
                      else:
                        - lvgl.button.update: { id: btn_mode_summer, styles: mode_btn }
                        - lvgl.label.update:  { id: txt_mode_summer, styles: mode_txt }

                  - if:
                      condition:
                        lambda: 'return id(heizmodus_select).state == "winter";'
                      then:
                        - lvgl.button.update: { id: btn_mode_winter, styles: mode_btn_active }
                        - lvgl.label.update:  { id: txt_mode_winter, styles: mode_txt_active }
                      else:
                        - lvgl.button.update: { id: btn_mode_winter, styles: mode_btn }
                        - lvgl.label.update:  { id: txt_mode_winter, styles: mode_txt }

                  - if:
                      condition:
                        lambda: 'return id(heizmodus_select).state == "pool";'
                      then:
                        - lvgl.button.update: { id: btn_mode_pool, styles: mode_btn_active }
                        - lvgl.label.update:  { id: txt_mode_pool, styles: mode_txt_active }
                      else:
                        - lvgl.button.update: { id: btn_mode_pool, styles: mode_btn }
                        - lvgl.label.update:  { id: txt_mode_pool, styles: mode_txt }

      # ---------- POOL page (2) ----------
      - if:
          condition:
            lambda: "return id(ui_page) == 2;"
          then:
            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_pool_fp_dirty);"
                then:
                  - lvgl.label.update:
                      id: lbl_pool_fp
                      text: !lambda |-
                        return id(filter_pumpe_enable_dac).state ? std::string("EIN") : std::string("AUS");

            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_pool_speed_dirty);"
                then:
                  - lvgl.label.update:
                      id: lbl_pool_speed
                      text: !lambda |-
                        float v = id(filter_pumpe_speed_pct).state;
                        if (!std::isfinite(v)) return std::string("-");
                        char b[16]; snprintf(b, sizeof(b), "%.0f%%", v);
                        return std::string(b);

            - if:
                condition:
                  lambda: "return id(ui_page_dirty) || id(ui_pool_dos_dirty);"
                then:
                  - lvgl.label.update:
                      id: lbl_pool_dos
                      text: !lambda |-
                        return id(dosierung_enable).state ? std::string("EIN") : std::string("AUS");

            - delay: 2ms

      # clear page-dirty and release busy
      - lambda: |-
          id(ui_page_dirty) = false;
          id(ui_busy) = false;


  - id: ui_refresh_slow
    mode: restart
    then:
      - if:
          condition:
            lambda: 'return !id(ui_ready) || id(ui_busy);'
          then:
            - lambda: 'return;'
          else:
            - lambda: 'id(ui_busy) = true;'

      - if:
          condition:
            lambda: |-
              return isfinite(id(dbg_heap_free_bytes).state) && id(dbg_heap_free_bytes).state < 30000;
          then:
            - lambda: 'id(ui_busy) = false; return;'
      - if:
          condition:
            lambda: "return id(ui_page) != 3;"
          then:
            - lambda: "id(ui_busy) = false;"
            - script.stop: ui_refresh_slow

      - lvgl.label.update:
          id: lbl_sys_uptime
          text: !lambda |-
            float up = id(ui_uptime_s).state;
            if (!std::isfinite(up) || up < 0) return std::string("-");
            uint32_t s = (uint32_t) up;

            uint32_t d   = s / 86400;
            uint32_t rem = s % 86400;
            uint32_t h   = rem / 3600;
            uint32_t m   = (rem % 3600) / 60;
            uint32_t sec = rem % 60;

            char b[24];
            snprintf(b, sizeof(b), "%ud %02u:%02u:%02u",
                     (unsigned)d, (unsigned)h, (unsigned)m, (unsigned)sec);
            return std::string(b);

      - delay: 2ms

      - lvgl.label.update:
          id: lbl_sys_loop
          text: !lambda |-
            float cur = id(dbg_loop_time).state;
            float mx  = id(dbg_loop_time_max_boot).state;
            if (!std::isfinite(cur) || !std::isfinite(mx)) return std::string("-");
            char b[24];
            snprintf(b, sizeof(b), "%.0f/%.0f ms", cur, mx);
            return std::string(b);

      - lvgl.label.update:
          id: lbl_sys_heap
          text: !lambda |-
            float kb = id(dbg_heap_free_kb).state;
            if (!std::isfinite(kb)) return std::string("-");
            char b[20];
            snprintf(b, sizeof(b), "%.0f KB", kb);
            return std::string(b);

      - delay: 2ms

      - lvgl.label.update:
          id: lbl_sys_ip
          text: !lambda |-
            if (!WiFi.isConnected()) return std::string("-");
            auto ip = WiFi.localIP();
            char b[20];
            snprintf(b, sizeof(b), "%u.%u.%u.%u", ip[0], ip[1], ip[2], ip[3]);
            return std::string(b);

      - delay: 2ms

      - lvgl.label.update:
          id: lbl_sys_reset
          text: !lambda |-
            esp_reset_reason_t rr = esp_reset_reason();
            const char* s = "UNKNOWN";
            switch (rr) {
              case ESP_RST_UNKNOWN:    s = "UNKNOWN"; break;
              case ESP_RST_POWERON:    s = "POWERON"; break;
              case ESP_RST_EXT:        s = "EXT"; break;
              case ESP_RST_SW:         s = "SW"; break;
              case ESP_RST_PANIC:      s = "PANIC"; break;
              case ESP_RST_INT_WDT:    s = "INT_WDT"; break;
              case ESP_RST_TASK_WDT:   s = "TASK_WDT"; break;
              case ESP_RST_WDT:        s = "WDT"; break;
              case ESP_RST_DEEPSLEEP:  s = "DEEPSLEEP"; break;
              case ESP_RST_BROWNOUT:   s = "BROWNOUT"; break;
              case ESP_RST_SDIO:       s = "SDIO"; break;
              case ESP_RST_USB:        s = "USB"; break;
              case ESP_RST_JTAG:       s = "JTAG"; break;
              case ESP_RST_EFUSE:      s = "EFUSE"; break;
              case ESP_RST_PWR_GLITCH: s = "PWR_GLITCH"; break;
              case ESP_RST_CPU_LOCKUP: s = "CPU_LOCKUP"; break;
              default: break;
            }
            return std::string(s);

      - lambda: 'id(ui_busy) = false;'


# ---------------- LVGL Layout ----------------
lvgl:
  displays:
    - tft
  touchscreens:
    - touchscreen_id: touch
  color_depth: 16
  buffer_size: 12%
  disp_bg_color: 0x070B12
  default_font: ui_font_m
  log_level: ERROR

  theme:
    label:
      text_color: 0xE7EEF9
    button:
      bg_color: 0x132033
      bg_opa: COVER
      radius: 14
      border_width: 1
      border_color: 0x22324B
      pressed:
        bg_color: 0x1A2A42
    buttonmatrix:
      bg_opa: TRANSP
      border_width: 0
      pad_all: 0
      items:
        bg_color: 0x0F1726
        bg_opa: COVER
        border_width: 1
        border_color: 0x22324B
        text_color: 0x9FB0C8
        pressed:
          bg_color: 0x1A2A42
          text_color: 0xFFFFFF
        checked:
          bg_color: 0x2B6FFF
          text_color: 0xFFFFFF

  style_definitions:
    - id: hdr
      bg_color: 0x0B1220
      bg_opa: COVER
      border_width: 0
      pad_left: 10
      pad_right: 10
      pad_top: 6
      pad_bottom: 6

    - id: chip
      bg_color: 0x0F1726
      bg_opa: COVER
      radius: 12
      pad_left: 8
      pad_right: 8
      pad_top: 4
      pad_bottom: 4
      border_width: 1
      border_color: 0x22324B

    - id: card
      bg_color: 0x0B1424
      bg_opa: COVER
      radius: 18
      pad_left: 12
      pad_right: 12
      pad_top: 6
      pad_bottom: 6
      border_width: 1
      border_color: 0x22324B

    - id: hero
      bg_color: 0x0D1A2F
      bg_opa: COVER
      radius: 20
      pad_left: 14
      pad_right: 14
      pad_top: 12
      pad_bottom: 10
      border_width: 1
      border_color: 0x2B6FFF

    - id: title
      text_color: 0x9FB0C8
      text_font: ui_font_s

    - id: vxl
      text_color: 0xFFFFFF
      text_font: ui_font_xl

    - id: vl
      text_color: 0xFFFFFF
      text_font: ui_font_l

    - id: vm
      text_color: 0xE7EEF9
      text_font: ui_font_m

    - id: nav
      bg_color: 0x070B12
      bg_opa: COVER
      border_width: 0
      pad_all: 4

    - id: mode_btn
      bg_color: 0x0F1726
      bg_opa: COVER
      radius: 14
      border_width: 1
      border_color: 0x22324B
      pad_left: 8
      pad_right: 8
      pad_top: 6
      pad_bottom: 6

    - id: mode_btn_active
      bg_color: 0x2B6FFF
      bg_opa: COVER
      radius: 14
      border_width: 1
      border_color: 0x2B6FFF
      pad_left: 8
      pad_right: 8
      pad_top: 6
      pad_bottom: 6

    - id: ghost_btn
      bg_opa: TRANSP
      border_width: 0
      pad_all: 0

    - id: mode_txt
      text_color: 0x9FB0C8
      text_font: ui_font_m

    - id: mode_txt_active
      text_color: 0xFFFFFF
      text_font: ui_font_m

    - id: wifi_icon
      text_font: mdi_wifi_24
      text_color: 0xE7EEF9

    - id: pump_on
      text_color: 0xFF3B30
      text_font: ui_font_m

    - id: pump_off
      text_color: 0xFFFFFF
      text_font: ui_font_m

    - id: burner_off
      text_color: 0xFFFFFF
      text_font: ui_font_m

    - id: burner_on
      text_color: 0xFFD400
      text_font: ui_font_m

    - id: burner_hot
      text_color: 0xFF3B30
      text_font: ui_font_m

  top_layer:
    widgets:
      - obj:
          align: bottom_mid
          width: 240
          height: 52
          styles: nav
          widgets:
            - buttonmatrix:
                id: nav_matrix
                one_checked: true
                width: 240
                height: 44
                pad_row: 0
                pad_column: 6
                rows:
                  - buttons:
                      - id: nav_status
                        text: "Status"
                        control: { checkable: true, checked: true }
                        on_value:
                          then:
                            - if:
                                condition: { lambda: "return x;" }
                                then:
                                  - lambda: |-
                                      id(ui_page) = 0;
                                      id(ui_page_dirty) = true;
                                  - lvgl.page.show: page_heat_status
                                  - script.execute: ui_refresh_fast

                      - id: nav_control
                        text: "Control"
                        control: { checkable: true }
                        on_value:
                          then:
                            - if:
                                condition: { lambda: "return x;" }
                                then:
                                  - lambda: |-
                                      id(ui_page) = 1;
                                      id(ui_page_dirty) = true;
                                  - lvgl.page.show: page_heat_control
                                  - script.execute: ui_refresh_fast

                      - id: nav_pool
                        text: "Pool"
                        control: { checkable: true }
                        on_value:
                          then:
                            - if:
                                condition: { lambda: "return x;" }
                                then:
                                  - lambda: |-
                                      id(ui_page) = 2;
                                      id(ui_page_dirty) = true;
                                  - lvgl.page.show: page_pool
                                  - script.execute: ui_refresh_fast

                      - id: nav_system
                        text: "System"
                        control: { checkable: true }
                        on_value:
                          then:
                            - if:
                                condition: { lambda: "return x;" }
                                then:
                                  - lambda: |-
                                      id(ui_page) = 3;
                                      id(ui_page_dirty) = true;
                                  - lvgl.page.show: page_system
                                  - script.execute: ui_refresh_fast
                                  - script.execute: ui_refresh_slow

  pages:
    - id: page_heat_status
      widgets:
        - obj:
            align: top_left
            x: 0
            y: 0
            width: 240
            height: 44
            styles: hdr
            widgets:
              - label: { text: "Heizung", align: left_mid, styles: vm }
              - label: { id: lbl_brenner, text: "B", align: right_mid, x: -76, styles: burner_off }
              - label: { id: lbl_pump_hz, text: "H", align: right_mid, x: -56, styles: pump_off }
              - label: { id: lbl_pump_ww, text: "W", align: right_mid, x: -36, styles: pump_off }
              - label: { id: lbl_wifi_icon, text: "\U000F092D", align: right_mid, x: -8, styles: wifi_icon }

        - obj:
            align: top_left
            x: 8
            y: 48
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Vorlauf", styles: title, align: top_left }
              - label: { id: lbl_card_vl, text: "-", styles: vl, align: bottom_left }

        - obj:
            align: top_left
            x: 123
            y: 48
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Außen", styles: title, align: top_left }
              - label: { id: lbl_card_outdoor, text: "-", styles: vl, align: bottom_left }

        - obj:
            align: top_left
            x: 8
            y: 110
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Kessel", styles: title, align: top_left }
              - label: { id: lbl_card_kessel, text: "-", styles: vl, align: bottom_left }

        - obj:
            align: top_left
            x: 123
            y: 110
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Warmwasser", styles: title, align: top_left }
              - label: { id: lbl_card_ww, text: "-", styles: vl, align: bottom_left }

        - obj:
            align: top_left
            x: 8
            y: 172
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Niveau", styles: title, align: top_left }
              - label: { id: lbl_card_level, text: "-", styles: vl, align: center }
              - button:
                  width: 36
                  height: 32
                  align: left_mid
                  x: 0
                  styles: ghost_btn
                  on_press:
                    then:
                      - script.execute: { id: ui_curve_level_nudge, delta: -0.5 }
                  widgets:
                    - label: { text: "–", align: center, styles: vm }
              - button:
                  width: 36
                  height: 32
                  align: right_mid
                  x: 0
                  styles: ghost_btn
                  on_press:
                    then:
                      - script.execute: { id: ui_curve_level_nudge, delta: 0.5 }
                  widgets:
                    - label: { text: "+", align: center, styles: vm }

        - obj:
            align: top_left
            x: 123
            y: 172
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Steigung", styles: title, align: top_left }
              - label: { id: lbl_card_slope, text: "-", styles: vl, align: bottom_left }

    - id: page_heat_control
      widgets:
        - obj:
            align: top_left
            x: 0
            y: 0
            width: 240
            height: 44
            styles: hdr
            widgets:
              - label: { text: "Control", align: left_mid, styles: vm }
              - obj:
                  align: right_mid
                  width: 110
                  height: 26
                  styles: chip
                  widgets:
                    - label: { id: lbl_mode_state, text: "Modus: -", align: center, styles: title }

        - obj:
            align: top_left
            x: 8
            y: 48
            width: 224
            height: 78
            styles: card
            widgets:
              - label: { text: "Heizmodus", align: top_left, styles: title }

              - button:
                  id: btn_mode_auto
                  align: top_left
                  x: 0
                  y: 26
                  width: 52
                  height: 44
                  styles: mode_btn
                  on_press:
                    then:
                      - script.execute: { id: set_mode_from_hmi, mode: "auto" }
                  widgets:
                    - label: { id: txt_mode_auto, text: "Auto", align: center, styles: mode_txt }

              - button:
                  id: btn_mode_summer
                  align: top_left
                  x: 58
                  y: 26
                  width: 52
                  height: 44
                  styles: mode_btn
                  on_press:
                    then:
                      - script.execute: { id: set_mode_from_hmi, mode: "summer" }
                  widgets:
                    - label: { id: txt_mode_summer, text: "Som", align: center, styles: mode_txt }

              - button:
                  id: btn_mode_winter
                  align: top_left
                  x: 116
                  y: 26
                  width: 52
                  height: 44
                  styles: mode_btn
                  on_press:
                    then:
                      - script.execute: { id: set_mode_from_hmi, mode: "winter" }
                  widgets:
                    - label: { id: txt_mode_winter, text: "Win", align: center, styles: mode_txt }

              - button:
                  id: btn_mode_pool
                  align: top_left
                  x: 174
                  y: 26
                  width: 50
                  height: 44
                  styles: mode_btn
                  on_press:
                    then:
                      - script.execute: { id: set_mode_from_hmi, mode: "pool" }
                  widgets:
                    - label: { id: txt_mode_pool, text: "Pool", align: center, styles: mode_txt }

        - obj:
            align: top_left
            x: 8
            y: 120
            width: 224
            height: 70
            styles: card
            widgets:
              - label: { text: "Vorlauf Soll", styles: title, align: top_left }
              - label: { id: lbl_ctl_vl, text: "-", styles: vl, align: left_mid, y: 10 }
              - button:
                  width: 56
                  height: 44
                  align: right_mid
                  x: -64
                  on_press:
                    then:
                      - script.execute: { id: ui_vl_nudge, delta: -0.5 }
                  widgets:
                    - label: { text: "–", align: center, styles: vm }
              - button:
                  width: 56
                  height: 44
                  align: right_mid
                  x: 0
                  on_press:
                    then:
                      - script.execute: { id: ui_vl_nudge, delta: 0.5 }
                  widgets:
                    - label: { text: "+", align: center, styles: vm }

        - obj:
            align: top_left
            x: 8
            y: 196
            width: 224
            height: 70
            styles: card
            widgets:
              - label: { text: "WW Soll", styles: title, align: top_left }
              - label: { id: lbl_ctl_ww, text: "-", styles: vl, align: left_mid, y: 10 }
              - button:
                  width: 56
                  height: 44
                  align: right_mid
                  x: -64
                  on_press:
                    then:
                      - script.execute: { id: ui_ww_nudge, delta: -0.5 }
                  widgets:
                    - label: { text: "–", align: center, styles: vm }
              - button:
                  width: 56
                  height: 44
                  align: right_mid
                  x: 0
                  on_press:
                    then:
                      - script.execute: { id: ui_ww_nudge, delta: 0.5 }
                  widgets:
                    - label: { text: "+", align: center, styles: vm }

    - id: page_pool
      widgets:
        - obj:
            align: top_left
            x: 0
            y: 0
            width: 240
            height: 44
            styles: hdr
            widgets:
              - label: { text: "Pool", align: left_mid, styles: vm }

        - obj:
            align: top_left
            x: 8
            y: 48
            width: 224
            height: 104
            styles: card
            widgets:
              - label: { text: "Filterpumpe", styles: title, align: top_left }
              - label: { text: "Status:", styles: title, align: top_left, y: 18 }
              - label: { id: lbl_pool_fp, text: "-", styles: vm, align: top_left, x: 58, y: 16 }
              - label: { text: "Speed:", styles: title, align: top_left, y: 40 }
              - label: { id: lbl_pool_speed, text: "-", styles: vm, align: top_left, x: 58, y: 38 }
              - button:
                  width: 68
                  height: 44
                  align: bottom_left
                  on_press:
                    then:
                      - script.execute: ui_toggle_filterpump
                  widgets:
                    - label: { text: "Toggle", align: center, styles: vm }
              - button:
                  width: 68
                  height: 44
                  align: bottom_mid
                  x: -36
                  on_press:
                    then:
                      - script.execute: { id: ui_filterpump_speed_nudge, delta: -5 }
                  widgets:
                    - label: { text: "-5%", align: center, styles: vm }
              - button:
                  width: 68
                  height: 44
                  align: bottom_mid
                  x: 36
                  on_press:
                    then:
                      - script.execute: { id: ui_filterpump_speed_nudge, delta: 5 }
                  widgets:
                    - label: { text: "+5%", align: center, styles: vm }

        - obj:
            align: top_left
            x: 8
            y: 158
            width: 224
            height: 108
            styles: card
            widgets:
              - label: { text: "Dosierung", styles: title, align: top_left }
              - label: { text: "Status:", styles: title, align: top_left, y: 18 }
              - label: { id: lbl_pool_dos, text: "-", styles: vm, align: top_left, x: 58, y: 16 }
              - button:
                  width: 224
                  height: 44
                  align: bottom_left
                  on_press:
                    then:
                      - script.execute: ui_toggle_dosierung
                  widgets:
                    - label: { text: "Toggle", align: center, styles: vm }

    - id: page_system
      widgets:
        - obj:
            align: top_left
            x: 0
            y: 0
            width: 240
            height: 44
            styles: hdr
            widgets:
              - label: { text: "System", align: left_mid, styles: vm }

        - obj:
            align: top_left
            x: 8
            y: 48
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Uptime", styles: title, align: top_left }
              - label: { id: lbl_sys_uptime, text: "-", styles: vm, align: bottom_left }

        - obj:
            align: top_left
            x: 123
            y: 48
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Loop cur/max", styles: title, align: top_left }
              - label: { id: lbl_sys_loop, text: "-", styles: vm, align: bottom_left }

        - obj:
            align: top_left
            x: 8
            y: 110
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "Heap", styles: title, align: top_left }
              - label: { id: lbl_sys_heap, text: "-", styles: vm, align: bottom_left }

        - obj:
            align: top_left
            x: 123
            y: 110
            width: 109
            height: 56
            styles: card
            widgets:
              - label: { text: "IP", styles: title, align: top_left }
              - label: { id: lbl_sys_ip, text: "-", styles: title, align: bottom_left }

        - obj:
            align: top_left
            x: 8
            y: 172
            width: 224
            height: 54
            styles: card
            widgets:
              - label: { text: "Reset Reason", styles: title, align: top_left }
              - label: { id: lbl_sys_reset, text: "-", styles: vm, align: bottom_left }

        - button:
            align: top_left
            x: 8
            y: 232
            width: 224
            height: 34
            on_press:
              then:
                - button.press: restart_button
            widgets:
              - label: { text: "Restart", align: center, styles: vm }
